<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SCADA - Tiempo Real</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0b1220; --panel:#111b31; --line:rgba(255,255,255,.10);
  --text:#e8eefc; --muted:rgba(232,238,252,.70);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.topbar{display:flex;justify-content:space-between;padding:14px;border-bottom:1px solid var(--line)}
.wrap{max-width:1200px;margin:auto;padding:16px}
.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
.card{background:var(--panel);border-radius:16px;padding:14px}
.kpi{font-size:34px;font-weight:900}
.chartWrap{height:320px}
canvas{width:100%!important;height:100%!important}
select,input{background:#1b2542;color:white;border:none;padding:6px;border-radius:8px}
</style>
</head>

<body>
<div class="topbar">
  <b>SCADA</b>
  <span id="status">Desconectado</span>
</div>

<div class="wrap">
  <div class="grid">
    <div class="card"><div>FA</div><div class="kpi" id="fa">--</div></div>
    <div class="card"><div>FB</div><div class="kpi" id="fb">--</div></div>
    <div class="card"><div>FC</div><div class="kpi" id="fc">--</div></div>
    <div class="card"><div>FD</div><div class="kpi" id="fd">--</div></div>

    <div class="card" style="grid-column:1/-1">
      <div>
        Se√±al:
        <select id="series">
          <option value="fa">FA</option>
          <option value="fb">FB</option>
          <option value="fc">FC</option>
          <option value="fd">FD</option>
        </select>
        Puntos:
        <input id="nPoints" type="number" value="60" min="10" max="300">
      </div>
      <div class="chartWrap">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const EXEC =
"https://script.google.com/macros/s/AKfycbx3k1r_PnEQGYr4ovEt_COTVxEoSlMEyjH6VkOwu3x56a77geBGkFflqq6xlTDnmNNzMA/exec";

const POLL=2000;

function jsonp(url){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    window[cb]=d=>{res(d);delete window[cb];s.remove()};
    const s=document.createElement("script");
    s.src=url+(url.includes("?")?"&":"?")+"callback="+cb+"&_="+Date.now();
    s.onerror=()=>rej("JSONP error");
    document.body.appendChild(s);
  });
}

const chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{labels:[],datasets:[{label:"FA",data:[],tension:.3}]},
  options:{responsive:true,animation:false}
});

async function loop(){
  try{
    const latest=await jsonp(EXEC+"?action=latest");
    ["fa","fb","fc","fd"].forEach(k=>{
      document.getElementById(k).textContent=latest.latest?.[k]??"--";
    });

    const n=document.getElementById("nPoints").value;
    const key=document.getElementById("series").value;
    const hist=await jsonp(EXEC+"?action=last&n="+n);

    chart.data.labels=hist.rows.map(r=>new Date(r.fecha).toLocaleTimeString());
    chart.data.datasets[0].label=key.toUpperCase();
    chart.data.datasets[0].data=hist.rows.map(r=>r[key]);
    chart.update();

    document.getElementById("status").textContent="Conectado";
  }catch(e){
    document.getElementById("status").textContent="Desconectado";
  }
  setTimeout(loop,POLL);
}

loop();
</script>
</body>
</html>
