<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Datos PZEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8">
            
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
                Monitor de Energ铆a (PZEM)
            </h1>

            <fieldset class="mb-6 border border-gray-300 p-4 rounded-lg">
                <legend class="text-xl font-semibold text-gray-700 px-2">Seleccionar Par谩metros</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-2">
                    
                    <div class="flex items-center p-2 hover:bg-gray-50 rounded">
                        <input id="chk1" type="checkbox" data-cols="Va,Vb,Vc" class="h-4 w-4 text-blue-600">
                        <label for="chk1" class="ml-2">1. Voltajes Fase (Va, Vb, Vc)</label>
                    </div>
                    <div class="flex items-center p-2 hover:bg-gray-50 rounded">
                        <input id="chk3" type="checkbox" data-cols="Ia,Ib,Ic" class="h-4 w-4 text-blue-600">
                        <label for="chk3" class="ml-2">3. Corrientes (Ia, Ib, Ic)</label>
                    </div>
                    <div class="flex items-center p-2 hover:bg-gray-50 rounded">
                        <input id="chk6" type="checkbox" data-cols="Pa,Pb,Pc" class="h-4 w-4 text-blue-600">
                        <label for="chk6" class="ml-2">6. Potencia Activa (W)</label>
                    </div>
                    </div>
            </fieldset>

            <div id="status-message" class="text-center p-4 my-4 text-gray-600 rounded-lg bg-gray-50 hidden"></div>

            <div id="data-container" class="space-y-4">
                <fieldset id="fs1" class="hidden border border-gray-300 p-4 rounded-lg"><legend class="text-blue-700 font-bold">1. Voltajes Fase</legend>
                    <div class="grid grid-cols-3 gap-4"><div class="p-2 bg-gray-100 rounded text-center"><small>Va</small><br><strong id="data-Va" class="text-xl">...</strong></div><div class="p-2 bg-gray-100 rounded text-center"><small>Vb</small><br><strong id="data-Vb" class="text-xl">...</strong></div><div class="p-2 bg-gray-100 rounded text-center"><small>Vc</small><br><strong id="data-Vc" class="text-xl">...</strong></div></div>
                </fieldset>
                <fieldset id="fs3" class="hidden border border-gray-300 p-4 rounded-lg"><legend class="text-blue-700 font-bold">3. Corrientes</legend>
                    <div class="grid grid-cols-3 gap-4"><div class="p-2 bg-gray-100 rounded text-center"><small>Ia</small><br><strong id="data-Ia" class="text-xl">...</strong></div><div class="p-2 bg-gray-100 rounded text-center"><small>Ib</small><br><strong id="data-Ib" class="text-xl">...</strong></div><div class="p-2 bg-gray-100 rounded text-center"><small>Ic</small><br><strong id="data-Ic" class="text-xl">...</strong></div></div>
                </fieldset>
                <fieldset id="fs6" class="hidden border border-gray-300 p-4 rounded-lg"><legend class="text-blue-700 font-bold">6. Potencia Activa</legend>
                    <div class="grid grid-cols-3 gap-4"><div class="p-2 bg-gray-100 rounded text-center"><small>Pa</small><br><strong id="data-Pa" class="text-xl">...</strong></div><div class="p-2 bg-gray-100 rounded text-center"><small>Pb</small><br><strong id="data-Pb" class="text-xl">...</strong></div><div class="p-2 bg-gray-100 rounded text-center"><small>Pc</small><br><strong id="data-Pc" class="text-xl">...</strong></div></div>
                </fieldset>
                
            </div>
            
            <fieldset id="fs-chart-container" class="hidden border border-gray-300 p-4 rounded-lg mt-6">
                <legend class="text-xl font-semibold text-gray-700 px-2">Gr谩fico en Tiempo Real</legend>
                <div class="p-2">
                    <canvas id="realTimeChart" style="max-height: 400px;"></canvas>
                </div>
            </fieldset>

            ---
            
            <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4">Consulta de Datos Hist贸ricos </h2>
            <fieldset class="mb-6 border border-indigo-300 p-4 rounded-lg bg-indigo-50">
                <legend class="text-lg font-semibold text-indigo-700 px-2">Selecci贸n de Rango</legend>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                    
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700">Fecha/Hora de Inicio:</label>
                        <input type="datetime-local" id="startDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700">Fecha/Hora Final:</label>
                        <input type="datetime-local" id="endDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>

                    <button id="fetchHistoricalBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150">
                        Consultar Hist贸rico
                    </button>
                </div>
            </fieldset>

            <fieldset id="fs-historical-chart-container" class="hidden border border-gray-300 p-4 rounded-lg mt-4">
                <legend class="text-xl font-semibold text-gray-700 px-2">Gr谩fico Hist贸rico</legend>
                <div id="historical-status" class="text-center p-2 my-2 text-gray-600"></div>
                <div class="p-2">
                    <canvas id="historicalChart" style="max-height: 450px;"></canvas>
                </div>
            </fieldset>

        </div>
    </div>

    <script>
        // --- CONFIGURACIN ---
        // Debes asegurarte de que tu Web App de Google Sheets acepte el nuevo par谩metro 'mode=historical'
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw4LQiQz54XQnOa7efHSc4MtAMlS8BySC0kfGqDedYAjkHv_pKdTTLkYnGBCN9HQkvK/exec';
        const MAX_DATA_POINTS = 30; // Solo para el gr谩fico en tiempo real

        // Almacenamiento global
        let realTimeChart = null; // Instancia para tiempo real
        let historicalChart = null; // Instancia para hist贸rico
        let chartDataHistory = {};
        let isFetching = false;
        const colorPalette = ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#a855f7', '#64748b'];

        // --- FUNCIONES DE GRFICOS ---
        
        // 1. Inicializa un gr谩fico (tiempo real o hist贸rico)
        function initializeChart(canvasId, chartType) {
            let chartInstance;
            if (chartType === 'realTime' && realTimeChart) {
                realTimeChart.destroy();
            } else if (chartType === 'historical' && historicalChart) {
                historicalChart.destroy();
            }

            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: chartType === 'realTime' ? false : true,
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: chartType === 'realTime' ? 'Comportamiento en Tiempo Real' : 'Datos Hist贸ricos' }
                    },
                    scales: { y: { beginAtZero: false } }
                }
            });

            if (chartType === 'realTime') {
                realTimeChart = chartInstance;
            } else {
                historicalChart = chartInstance;
            }
        }
        
        // 2. Actualiza el gr谩fico en tiempo real
        function updateRealTimeChart(data) {
            if (!realTimeChart) return;

            let requestedCols = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
                requestedCols.push(...chk.dataset.cols.split(','));
            });
            const activeCols = [...new Set(requestedCols)];

            if (activeCols.length === 0) {
                document.getElementById('fs-chart-container').classList.add('hidden');
                return;
            }
            document.getElementById('fs-chart-container').classList.remove('hidden');

            const newTimestamp = new Date().toLocaleTimeString();
            let newDatasets = [];

            // 1. Gestionar el historial
            activeCols.forEach((col, index) => {
                if (!chartDataHistory[col]) {
                    chartDataHistory[col] = {
                        label: col,
                        data: [],
                        borderColor: colorPalette[index % colorPalette.length],
                        backgroundColor: colorPalette[index % colorPalette.length],
                        tension: 0.2,
                        pointRadius: 3
                    };
                }

                const newValue = data[col] !== undefined ? data[col] : null;
                chartDataHistory[col].data.push(newValue);
                
                if (chartDataHistory[col].data.length > MAX_DATA_POINTS) {
                    chartDataHistory[col].data.shift();
                }
                
                newDatasets.push(chartDataHistory[col]);
            });

            // Limpiar historial de columnas no seleccionadas
            for (const key in chartDataHistory) {
                if (!activeCols.includes(key)) {
                    delete chartDataHistory[key];
                }
            }
            
            // 2. Gestionar etiquetas de tiempo (X-Axis)
            if (!realTimeChart.data.labels) realTimeChart.data.labels = [];
            realTimeChart.data.labels.push(newTimestamp);

            if (realTimeChart.data.labels.length > MAX_DATA_POINTS) {
                realTimeChart.data.labels.shift();
            }

            // 3. Actualizar
            realTimeChart.data.datasets = newDatasets;
            realTimeChart.update();
        }

        // 3. Renderiza el gr谩fico hist贸rico con los datos recibidos
        function renderHistoricalChart(historicalData) {
            const chartContainer = document.getElementById('fs-historical-chart-container');
            const statusDiv = document.getElementById('historical-status');
            
            if (historicalData.length === 0) {
                statusDiv.textContent = 'No se encontraron datos en el rango seleccionado.';
                chartContainer.classList.remove('hidden');
                if(historicalChart) historicalChart.data.datasets = []; // Limpiar gr谩fico
                return;
            }

            statusDiv.textContent = `Mostrando ${historicalData.length} registros.`;
            chartContainer.classList.remove('hidden');

            // Nombres de las columnas (asumiendo que la primera fila es el encabezado, o bas谩ndonos en los datos)
            const cols = Object.keys(historicalData[0]).filter(key => key !== 'Timestamp');
            
            const labels = historicalData.map(row => row.Timestamp);
            let datasets = [];

            cols.forEach((col, index) => {
                datasets.push({
                    label: col,
                    data: historicalData.map(row => row[col]),
                    borderColor: colorPalette[index % colorPalette.length],
                    backgroundColor: 'transparent',
                    tension: 0.1,
                    pointRadius: 1
                });
            });

            // Destruir e inicializar con nuevos datos
            if (historicalChart) historicalChart.destroy();
            initializeChart('historicalChart', 'historical');
            
            historicalChart.data.labels = labels;
            historicalChart.data.datasets = datasets;
            historicalChart.update();
        }

        // --- FUNCIN FETCH DATA (TIEMPO REAL) ---
        async function fetchData() {
            if (isFetching) return;

            let requestedCols = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
                requestedCols.push(...chk.dataset.cols.split(','));
            });

            const statusDiv = document.getElementById('status-message');

            if (requestedCols.length === 0) {
                statusDiv.classList.add('hidden');
                document.getElementById('fs-chart-container').classList.add('hidden');
                return;
            }

            isFetching = true;
            statusDiv.textContent = "Actualizando datos en tiempo real...";
            statusDiv.classList.remove('hidden', 'text-red-600', 'bg-red-100');
            statusDiv.classList.add('bg-gray-50', 'text-gray-600');

            try {
                const colsParam = [...new Set(requestedCols)].join(',');
                // El modo por defecto es 'realtime'
                const url = `${GAS_WEB_APP_URL}?mode=realtime&colsToQuery=${colsParam}`;

                const response = await fetch(url, { redirect: 'follow' });
                const json = await response.json();

                if (json.status === 'success') {
                    updateUI(json.data);
                    updateRealTimeChart(json.data);
                    
                    statusDiv.textContent = `Actualizado: Fila ${json.lastRow}`;
                    statusDiv.classList.add('fade-in');
                    setTimeout(() => {
                        if(!isFetching) statusDiv.classList.add('hidden');
                    }, 2000);

                } else {
                    throw new Error(json.error || 'Error desconocido');
                }
            } catch (error) {
                console.error("Error RT:", error);
                statusDiv.textContent = "Error RT: Fallo en conexi贸n o datos.";
                statusDiv.classList.remove('text-gray-600', 'bg-gray-50');
                statusDiv.classList.add('text-red-600', 'bg-red-100');
                statusDiv.classList.add('fade-in');
            } finally {
                isFetching = false;
            }
        }

        // --- FUNCIN FETCH DATA (HISTRICO) (NUEVO) ---
        async function fetchHistoricalData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const statusDiv = document.getElementById('historical-status');
            const chartContainer = document.getElementById('fs-historical-chart-container');
            
            // Validaciones
            if (!startDate || !endDate) {
                statusDiv.textContent = 'Por favor, selecciona una fecha y hora de inicio y fin.';
                chartContainer.classList.remove('hidden');
                return;
            }

            // Obtener columnas seleccionadas
            let requestedCols = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
                requestedCols.push(...chk.dataset.cols.split(','));
            });
            
            if (requestedCols.length === 0) {
                statusDiv.textContent = 'Selecciona al menos un par谩metro (Voltajes, Corrientes, etc.) para la consulta hist贸rica.';
                chartContainer.classList.remove('hidden');
                return;
            }
            
            // Mostrar estado
            statusDiv.textContent = "Consultando datos hist贸ricos...";
            chartContainer.classList.remove('hidden');
            
            try {
                const colsParam = [...new Set(requestedCols)].join(',');
                
                // Formato de fecha para pasar por URL (ej: YYYY-MM-DDTHH:MM)
                const url = `${GAS_WEB_APP_URL}?mode=historical&start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}&colsToQuery=${colsParam}`;
                
                const response = await fetch(url, { redirect: 'follow' });
                const json = await response.json();

                if (json.status === 'success') {
                    renderHistoricalChart(json.data);
                } else {
                    throw new Error(json.error || 'Error desconocido en la respuesta del servidor.');
                }
            } catch (error) {
                console.error("Error Hist贸rico:", error);
                statusDiv.textContent = `Error al obtener datos hist贸ricos: ${error.message}`;
            }
        }

        // --- LGICA PRINCIPAL ---
        document.addEventListener('DOMContentLoaded', function() {
            const ids = [1, 3, 6]; // Ajustar a los IDs de los checkboxes que tienes
            
            // Configurar Listeners para visibilidad de datos en tiempo real
            ids.forEach(id => {
                const chk = document.getElementById('chk' + id);
                const fs = document.getElementById('fs' + id);
                if(chk && fs) {
                    chk.addEventListener('change', () => {
                        fs.classList.toggle('hidden', !chk.checked);
                        // Limpiar historial al cambiar la selecci贸n para un gr谩fico nuevo
                        chartDataHistory = {}; 
                        initializeChart('realTimeChart', 'realTime');
                        fetchData(); 
                    });
                }
            });
            
            // Listener para el bot贸n de consulta hist贸rica
            document.getElementById('fetchHistoricalBtn').addEventListener('click', fetchHistoricalData);

            // Inicializar ambos gr谩ficos al cargar la p谩gina (vac铆os)
            initializeChart('realTimeChart', 'realTime');
            initializeChart('historicalChart', 'historical');
            
            // Refresco inicial y peri贸dico
            fetchData();
            setInterval(fetchData, 5000);
        });

        // Funci贸n de actualizaci贸n de valores (UI)
        function updateUI(data) {
            for (const key in data) {
                const el = document.getElementById(`data-${key}`);
                if (el) {
                    let val = data[key];
                    if (typeof val === 'number') val = val.toFixed(2);
                    
                    el.textContent = val;
                    
                    el.classList.remove('fade-in');
                    void el.offsetWidth;
                    el.classList.add('fade-in');
                }
            }
        }
    </script>
</body>
</html>
