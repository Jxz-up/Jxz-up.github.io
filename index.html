<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SCADA PZEM — Dashboard (Estilo B) - Agrupado</title>

<!-- Tailwind (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#0b1221;
    --panel:#0f1724;
    --muted:#94a3b8;
    --accent:#3b82f6;
    --accent-2:#7c3aed;
    --ok:#10b981;
    --warn:#f59e0b;
    --danger:#ef4444;
  }
  html,body{height:100%;background:radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,0.05), transparent), var(--bg); color:#e6eef8; margin:0;}
  .glass{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px); }
  .neon { box-shadow: 0 6px 18px rgba(59,130,246,0.06); }
  .card-value{font-weight:700; font-size:1.25rem;}
  .small-muted{ color: var(--muted); font-size:0.85rem; }
  .group-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
  @media (max-width: 1024px){ .group-grid{ grid-template-columns:repeat(1,1fr); } }
  .data-row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,0.02); }
  .key { color: var(--muted); font-size:0.9rem; }
  .val { font-weight:600; }
  .status-pill { padding:4px 8px; border-radius:8px; font-size:0.85rem; }
  table.small { font-size:0.85rem; color:var(--muted); width:100%; border-collapse:collapse; }
  table.small td, table.small th { padding:6px; border-bottom:1px solid rgba(255,255,255,0.02); }
</style>
</head>
<body class="antialiased">
  <div class="min-h-screen flex">
    <!-- SIDEBAR -->
    <aside class="w-64 hidden lg:block p-4">
      <div class="glass rounded-2xl h-full p-4 flex flex-col neon">
        <div class="mb-6">
          <h2 class="text-2xl font-bold" style="color: white">PZEM SCADA</h2>
          <p class="small-muted mt-1">Dashboard Agrupado — Estilo B</p>
        </div>

        <nav class="mt-6 space-y-2">
          <a class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition" href="#">Resumen</a>
          <a class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition" href="#">Gráficas</a>
          <a class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition" href="#">Ajustes</a>
        </nav>

        <div class="mt-auto text-xs small-muted">
          <div>Últ. actualización: <span id="last-update">--:--:--</span></div>
          <div class="mt-3">Servidor: <strong id="server-status" class="text-green-400">Conectado</strong></div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 p-4">
      <header class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-2xl font-semibold">Monitor PZEM — Dashboard Agrupado</h1>
          <p class="small-muted mt-1">Actualización automática cada 3s · Estilo B</p>
        </div>

        <div class="flex items-center gap-3">
          <button id="btn-refresh" class="px-3 py-2 rounded-lg glass hover:scale-105 transition">Refrescar</button>
          <div class="small-muted">Alarma: <span id="alarm-toggle" class="status-pill glass">ACTIVADA</span></div>
        </div>
      </header>

      <!-- GRID: grouped cards -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <!-- Voltajes (agrupado) -->
        <div class="glass rounded-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="small-muted">Voltajes</div>
              <div class="text-lg font-bold">Fase & Línea</div>
            </div>
            <div class="small-muted">V / Línea</div>
          </div>

          <div class="group-grid">
            <div>
              <div class="data-row"><div class="key">Va</div><div class="val" id="Va">--</div></div>
              <div class="data-row"><div class="key">Vb</div><div class="val" id="Vb">--</div></div>
              <div class="data-row"><div class="key">Vc</div><div class="val" id="Vc">--</div></div>
            </div>
            <div>
              <div class="data-row"><div class="key">Vab</div><div class="val" id="Vab">--</div></div>
              <div class="data-row"><div class="key">Vbc</div><div class="val" id="Vbc">--</div></div>
              <div class="data-row"><div class="key">Vca</div><div class="val" id="Vca">--</div></div>
            </div>
            <div>
              <div class="data-row"><div class="key">E. Activa (E_Pt)</div><div class="val" id="E_Pt">--</div></div>
              <div class="data-row"><div class="key">E. Reactiva (E_Qt)</div><div class="val" id="E_Qt">--</div></div>
              <div class="data-row"><div class="key">E. Aparente (E_St)</div><div class="val" id="E_St">--</div></div>
            </div>
          </div>
        </div>

        <!-- Corrientes -->
        <div class="glass rounded-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="small-muted">Corrientes</div>
              <div class="text-lg font-bold">Ia / Ib / Ic</div>
            </div>
            <div class="small-muted">A</div>
          </div>
          <div class="group-grid">
            <div>
              <div class="data-row"><div class="key">Ia</div><div class="val" id="Ia">--</div></div>
              <div class="data-row"><div class="key">Ib</div><div class="val" id="Ib">--</div></div>
              <div class="data-row"><div class="key">Ic</div><div class="val" id="Ic">--</div></div>
            </div>
            <div>
              <div class="data-row"><div class="key">Pt (Total)</div><div class="val" id="Pt">--</div></div>
              <div class="data-row"><div class="key">Qt (Total)</div><div class="val" id="Qt">--</div></div>
              <div class="data-row"><div class="key">St (Total)</div><div class="val" id="St">--</div></div>
            </div>
            <div>
              <div class="data-row"><div class="key">FP Total</div><div class="val" id="FP_Total">--</div></div>
              <div class="data-row"><div class="key">Fecha/Hora</div><div class="val" id="TS">--</div></div>
              <div class="data-row"><div class="key">Estado</div><div class="val" id="SYS_STATUS">--</div></div>
            </div>
          </div>
        </div>

        <!-- Potencias (Activa / Reactiva / Aparente) -->
        <div class="glass rounded-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="small-muted">Potencias</div>
              <div class="text-lg font-bold">Activa / Reactiva / Aparente</div>
            </div>
            <div class="small-muted">W / VAR / VA</div>
          </div>

          <div class="group-grid">
            <div>
              <div class="data-row"><div class="key">Pa</div><div class="val" id="Pa">--</div></div>
              <div class="data-row"><div class="key">Pb</div><div class="val" id="Pb">--</div></div>
              <div class="data-row"><div class="key">Pc</div><div class="val" id="Pc">--</div></div>
            </div>

            <div>
              <div class="data-row"><div class="key">Qa</div><div class="val" id="Qa">--</div></div>
              <div class="data-row"><div class="key">Qb</div><div class="val" id="Qb">--</div></div>
              <div class="data-row"><div class="key">Qc</div><div class="val" id="Qc">--</div></div>
            </div>

            <div>
              <div class="data-row"><div class="key">Sa</div><div class="val" id="Sa">--</div></div>
              <div class="data-row"><div class="key">Sb</div><div class="val" id="Sb">--</div></div>
              <div class="data-row"><div class="key">Sc</div><div class="val" id="Sc">--</div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Second row: Frequencies & FP -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Frecuencias</div>
          <div class="text-lg font-bold mb-2">Fa / Fb / Fc</div>
          <div class="data-row"><div class="key">Fa</div><div class="val" id="Fa">--</div></div>
          <div class="data-row"><div class="key">Fb</div><div class="val" id="Fb">--</div></div>
          <div class="data-row"><div class="key">Fc</div><div class="val" id="Fc">--</div></div>
        </div>

        <div class="glass rounded-xl p-4">
          <div class="small-muted">Factor de Potencia</div>
          <div class="text-lg font-bold mb-2">FP por fase</div>
          <div class="data-row"><div class="key">FPa</div><div class="val" id="FPa">--</div></div>
          <div class="data-row"><div class="key">FPb</div><div class="val" id="FPb">--</div></div>
          <div class="data-row"><div class="key">FPc</div><div class="val" id="FPc">--</div></div>
        </div>

        <div class="glass rounded-xl p-4">
          <div class="small-muted">Control</div>
          <div class="text-lg font-bold mb-2">Acciones</div>
          <div style="display:flex; gap:8px;">
            <button id="btn-export" class="px-3 py-2 rounded-lg glass">Exportar CSV</button>
            <button id="btn-clear" class="px-3 py-2 rounded-lg glass">Limpiar tabla</button>
          </div>
        </div>
      </section>

      <!-- Charts -->
      <section class="glass rounded-xl p-4 mb-6">
        <div class="flex items-center justify-between mb-3">
          <div><div class="small-muted">Gráficas</div><div class="text-lg font-bold">Voltajes / Corrientes / Potencias</div></div>
          <div class="small-muted">Últimos 30 puntos</div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <canvas id="chartVoltajes" height="120"></canvas>
          <canvas id="chartCorrientes" height="120"></canvas>
        </div>
        <div style="margin-top:12px;"><canvas id="chartPotencias" height="80"></canvas></div>
      </section>

      <!-- Histórico -->
      <section class="glass rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div><div class="small-muted">Histórico</div><div class="text-lg font-bold">Últimos registros (local)</div></div>
          <div class="small-muted">Se guarda en la tabla visual</div>
        </div>
        <div class="overflow-x-auto">
          <table class="small">
            <thead>
              <tr>
                <th>Hora</th><th>Va</th><th>Vb</th><th>Vc</th><th>Ia</th><th>Ib</th><th>Ic</th><th>Pt</th>
              </tr>
            </thead>
            <tbody id="historic-body"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

<script>
/* DASHBOARD AGRUPADO — Estilo B
   Reemplaza GAS_WEB_APP_URL por la URL del Apps Script desplegado (Web App)
*/
const GAS_WEB_APP_URL = "TU_URL_WEBAPP_AQUI"; // <-- coloca aquí tu URL

// Pedimos todas las claves importantes (incluye Vab,Vbc,Vca para cálculo si tu backend las devuelve)
const COLUMNS = [
  "Va","Vb","Vc","Vab","Vbc","Vca",
  "Ia","Ib","Ic",
  "Fa","Fb","Fc",
  "Pa","Pb","Pc",
  "Qa","Qb","Qc",
  "Sa","Sb","Sc",
  "Pt","Qt","St",
  "FPa","FPb","FPc",
  "FP_Total","E_Pt","E_Qt","E_St"
];

let isFetching = false;
let maxPoints = 30;
let charts = {};
let labels = [], VaData = [], VbData = [], VcData = [], IaData = [], IbData = [], IcData = [], PaData = [], PbData = [], PcData = [];

document.addEventListener("DOMContentLoaded", () => {
  setupCharts();
  document.getElementById("btn-refresh").addEventListener("click", fetchAndUpdate);
  document.getElementById("btn-export").addEventListener("click", exportCSV);
  document.getElementById("btn-clear").addEventListener("click", clearHistoric);
  fetchAndUpdate();
  setInterval(fetchAndUpdate, 3000);
});

function setupCharts(){
  charts.volt = new Chart(document.getElementById("chartVoltajes"), {
    type:"line",
    data:{ labels:labels, datasets:[
      {label:"Va", data:VaData, borderWidth:2, tension:0.25},
      {label:"Vb", data:VbData, borderWidth:2, tension:0.25},
      {label:"Vc", data:VcData, borderWidth:2, tension:0.25}
    ]},
    options:{ responsive:true, plugins:{legend:{labels:{color:"#dbeafe"}}}, scales:{ x:{ ticks:{color:"#9fb5ff"} }, y:{ ticks:{color:"#9fb5ff"} } } }
  });

  charts.curr = new Chart(document.getElementById("chartCorrientes"), {
    type:"line",
    data:{ labels:labels, datasets:[
      {label:"Ia", data:IaData, borderWidth:2, tension:0.25},
      {label:"Ib", data:IbData, borderWidth:2, tension:0.25},
      {label:"Ic", data:IcData, borderWidth:2, tension:0.25}
    ]},
    options:{ responsive:true, plugins:{legend:{labels:{color:"#dbeafe"}}}, scales:{ x:{ ticks:{color:"#9fb5ff"} }, y:{ ticks:{color:"#9fb5ff"} } } }
  });

  charts.pow = new Chart(document.getElementById("chartPotencias"), {
    type:"bar",
    data:{ labels:["Pa","Pb","Pc"], datasets:[{label:"W", data:[0,0,0], barThickness:22}]},
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ x:{ ticks:{color:"#dbeafe"} }, y:{ ticks:{color:"#dbeafe"} } } }
  });
}

async function fetchAndUpdate(){
  if (isFetching) return;
  isFetching = true;
  document.getElementById("last-update").textContent = new Date().toLocaleTimeString();

  const colsParam = COLUMNS.join(",");
  try {
    const res = await fetch(`${GAS_WEB_APP_URL}?colsToQuery=${encodeURIComponent(colsParam)}`, {cache:"no-store"});
    const json = await res.json();

    if (json.status !== "success") {
      throw new Error(json.error || "Respuesta no exitosa");
    }

    const d = json.data || {};

    // Helper: return numeric or 0
    const num = v => (v === null || v === undefined || v === "" ? 0 : Number(v));
    const fmt = v => (v === null || v === undefined || v === "" ? "--" : (isNaN(Number(v)) ? v : Number(v).toFixed(2)));

    // Map many keys (safely)
    const mapping = {
      Va: num(d.Va), Vb: num(d.Vb), Vc: num(d.Vc),
      Vab: num(d.Vab), Vbc: num(d.Vbc), Vca: num(d.Vca),
      Ia: num(d.Ia), Ib: num(d.Ib), Ic: num(d.Ic),
      Fa: num(d.Fa), Fb: num(d.Fb), Fc: num(d.Fc),
      Pa: num(d.Pa), Pb: num(d.Pb), Pc: num(d.Pc),
      Qa: num(d.Qa), Qb: num(d.Qb), Qc: num(d.Qc),
      Sa: num(d.Sa), Sb: num(d.Sb), Sc: num(d.Sc),
      Pt: num(d.Pt), Qt: num(d.Qt), St: num(d.St),
      FPa: d.FPa, FPb: d.FPb, FPc: d.FPc, FP_Total: d.FP_Total,
      E_Pt: d.E_Pt, E_Qt: d.E_Qt, E_St: d.E_St
    };

    // Update grouped fields (text)
    Object.keys(mapping).forEach(k => {
      const el = document.getElementById(k);
      if (!el) return;
      // show numeric formatted or raw string
      if (typeof mapping[k] === "number") el.textContent = mapping[k].toFixed(2);
      else el.textContent = (mapping[k] === null || mapping[k] === undefined || mapping[k] === "") ? "--" : mapping[k];
    });

    // Timestamp (from backend lastRow) - if provided
    if (json.lastRow) {
      document.getElementById("TS").textContent = `Fila ${json.lastRow}`;
    } else {
      document.getElementById("TS").textContent = new Date().toLocaleString();
    }

    // FP total
    const fpTotal = d.FP_Total || d.FP || d.FPa || "--";
    document.getElementById("FP_Total").textContent = (fpTotal === null || fpTotal === undefined) ? "--" : (isNaN(Number(fpTotal)) ? fpTotal : Number(fpTotal).toFixed(2));

    // SYS_STATUS quick logic
    document.getElementById("SYS_STATUS").textContent = "OK";

    // Update historic table and charts
    addHistoricRow(new Date(), mapping.Va, mapping.Vb, mapping.Vc, mapping.Ia, mapping.Ib, mapping.Ic, mapping.Pt);

    pushPoint(new Date().toLocaleTimeString(), mapping.Va, mapping.Vb, mapping.Vc, mapping.Ia, mapping.Ib, mapping.Ic, mapping.Pa, mapping.Pb, mapping.Pc);

    // Update potencias bar
    charts.pow.data.datasets[0].data = [
      mapping.Pa || 0, mapping.Pb || 0, mapping.Pc || 0
    ];
    charts.pow.update();

    // server status
    document.getElementById("server-status").textContent = "Conectado";
    document.getElementById("server-status").classList.remove("text-red-400");
    document.getElementById("server-status").classList.add("text-green-400");

  } catch (err) {
    console.error("Fetch error:", err);
    document.getElementById("server-status").textContent = "Error";
    document.getElementById("server-status").classList.remove("text-green-400");
    document.getElementById("server-status").classList.add("text-red-400");
  } finally {
    isFetching = false;
  }
}

// Historic table local
function addHistoricRow(ts, Va, Vb, Vc, Ia, Ib, Ic, Pt){
  const tbody = document.getElementById("historic-body");
  if(!tbody) return;
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${ts.toLocaleTimeString()}</td>
    <td>${(Va||0).toFixed(2)}</td>
    <td>${(Vb||0).toFixed(2)}</td>
    <td>${(Vc||0).toFixed(2)}</td>
    <td>${(Ia||0).toFixed(2)}</td>
    <td>${(Ib||0).toFixed(2)}</td>
    <td>${(Ic||0).toFixed(2)}</td>
    <td>${(Pt||0).toFixed(2)}</td>
  `;
  tbody.prepend(tr);
  while(tbody.children.length > 20) tbody.removeChild(tbody.lastChild);
}

function pushPoint(label, Va, Vb, Vc, Ia, Ib, Ic, Pa, Pb, Pc){
  labels.push(label);
  VaData.push(Va||0); VbData.push(Vb||0); VcData.push(Vc||0);
  IaData.push(Ia||0); IbData.push(Ib||0); IcData.push(Ic||0);
  PaData.push(Pa||0); PbData.push(Pb||0); PcData.push(Pc||0);

  if (labels.length > maxPoints){
    labels.shift();
    VaData.shift(); VbData.shift(); VcData.shift();
    IaData.shift(); IbData.shift(); IcData.shift();
    PaData.shift(); PbData.shift(); PcData.shift();
  }

  charts.volt.data.labels = labels;
  charts.volt.data.datasets[0].data = VaData;
  charts.volt.data.datasets[1].data = VbData;
  charts.volt.data.datasets[2].data = VcData;
  charts.volt.update();

  charts.curr.data.labels = labels;
  charts.curr.data.datasets[0].data = IaData;
  charts.curr.data.datasets[1].data = IbData;
  charts.curr.data.datasets[2].data = IcData;
  charts.curr.update();
}

// Export local historic table to CSV
function exportCSV(){
  const rows = [];
  const tbody = document.getElementById("historic-body");
  if(!tbody) return alert("No hay datos para exportar");
  // header
  rows.push(["Hora","Va","Vb","Vc","Ia","Ib","Ic","Pt"]);
  Array.from(tbody.children).forEach(tr => {
    const cols = Array.from(tr.children).map(td => td.textContent.trim());
    rows.push(cols);
  });
  const csv = rows.map(r => r.map(cell => `"${cell.replace(/"/g,'""')}"`).join(",")).join("\r\n");
  const blob = new Blob([csv], {type: "text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `historic_pzem_${new Date().toISOString().slice(0,19)}.csv`; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

// Clear historic
function clearHistoric(){
  const tbody = document.getElementById("historic-body");
  if(tbody) tbody.innerHTML = "";
}

</script>
</body>
</html>
