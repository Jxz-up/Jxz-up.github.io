<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control IoT (Auto-Actualización)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Solo conservamos el azul para el botón de lectura
                        'primary-blue': '#1e40af',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos base para el cuerpo */
        body {
            background-color: #f7f9fb;
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">Visualizador de Últimos Datos Registrados</h1>
        
        <div id="read-box" class="bg-white shadow-xl rounded-xl p-6 mb-8 border-t-4 border-primary-blue transition-all duration-300 hover:shadow-2xl">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-primary-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 4m0 5h7m7 7v5h-.583m-15.356-2A8.001 8.001 0 0019.418 20m0-5h-7"></path></svg>
                Datos de la Última Fila (Auto-Actualización cada 3s)
            </h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="p-3 bg-gray-50 rounded-lg sm:col-span-2">
                    <p class="text-sm text-gray-500">Timestamp del registro:</p>
                    <p class="text-base font-medium" id="output-timestamp">Cargando...</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-500">Valor Va:</p>
                    <p class="text-xl font-bold text-primary-blue" id="output-va">N/A</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-500">Valor Vb:</p>
                    <p class="text-xl font-bold text-gray-600" id="output-vb">N/A</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-500">Valor Vc:</p>
                    <p class="text-xl font-bold text-red-500" id="output-vc">N/A</p>
                </div>
            </div>

            <button onclick="leerDatos()" class="w-full bg-primary-blue hover:bg-blue-800 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 shadow-lg">
                Actualizar Ahora
            </button>
        </div>
    </div>

    <div id="message-container" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        // Función para mostrar mensajes de usuario (reemplaza alert())
        function showMessage(text, isError = false) {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            
            // Usamos un color de fondo fijo para el éxito (verde) y el error (rojo)
            messageDiv.className = `p-4 rounded-lg shadow-lg text-white mb-2 transition-opacity duration-500 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            messageDiv.textContent = text;
            container.appendChild(messageDiv);

            // Eliminar después de 4 segundos
            setTimeout(() => {
                messageDiv.classList.remove('opacity-100');
                messageDiv.classList.add('opacity-0');
                setTimeout(() => messageDiv.remove(), 500);
            }, 4000);
        }

        // ¡IMPORTANTE! Reemplaza con la URL de tu Aplicación Web de Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzHjerhdwTyuf-LJtcm87K7jX-QCvVYJlmvaDLgFbrX67DsiX1sPPGBNm1E6zujclKN/exec'; 
        let isFirstLoad = true;

        // Función para LEER datos (Solicitud GET)
        async function leerDatos() {
            try {
                const response = await fetch(SCRIPT_URL, { method: 'GET' });
                const data = await response.json();

                // Verifica si el script devolvió un error (ej. si no hay datos)
                if (data.error) {
                    showMessage('Error: ' + data.error, true);
                    // Mostrar Error si hay problema
                    document.getElementById('output-timestamp').textContent = 'Error de Lectura';
                    document.getElementById('output-va').textContent = 'Error';
                    document.getElementById('output-vb').textContent = 'Error';
                    document.getElementById('output-vc').textContent = 'Error';
                    return;
                }

                // Formatear la fecha para que sea legible
                const timestamp = new Date(data.Timestamp).toLocaleString();

                // Mostrar los datos en la página
                document.getElementById('output-timestamp').textContent = timestamp;
                document.getElementById('output-va').textContent = data.Va;
                document.getElementById('output-vb').textContent = data.Vb;
                document.getElementById('output-vc').textContent = data.Vc;
                
                if (isFirstLoad) {
                    showMessage('Datos iniciales cargados. La actualización es automática.', false);
                    isFirstLoad = false;
                }

            } catch (error) {
                showMessage('Fallo en la conexión. Revisa el SCRIPT_URL y la red.', true);
                console.error('Fetch error:', error);
            }
        }
        
        // 1. Llama a la función de lectura inmediatamente al cargar.
        leerDatos(); 

        // 2. Configura la función de recarga automática cada 3000 milisegundos (3 segundos).
        setInterval(leerDatos, 3000);
    </script>
</body>
</html>
