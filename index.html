<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SCADA PZEM ‚Äî Dashboard (Agrupado por categor√≠a)</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#0b1221; --panel:#0f1724; --muted:#94a3b8;
    --accent:#3b82f6; --accent-2:#7c3aed; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  }
  html,body{height:100%;background:radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,0.05), transparent), var(--bg); color:#e6eef8; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;}
  .glass{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px); }
  .neon{ box-shadow: 0 6px 18px rgba(59,130,246,0.06); }
  .small-muted{ color: var(--muted); font-size:0.88rem; }
  .card-value{ font-weight:700; font-size:1.25rem; color:#e6eef8; }
  .nav-link{ display:flex; gap:12px; align-items:center; padding:10px 12px; border-radius:8px; color:#cfe6ff; }
  .nav-link:hover{ background:rgba(255,255,255,0.02); transform:translateX(4px); transition:all .15s; }
  .status-pill{ padding:6px 10px; border-radius:999px; font-size:0.82rem; }
  .data-row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,0.02); }
  .key{ color:var(--muted); font-size:0.9rem; }
  .val{ font-weight:600; }
  .topbar-btn{ padding:8px 12px; border-radius:10px; }
  @media (max-width:1024px){ aside{ display:none } }
</style>
</head>
<body>

<div class="min-h-screen flex">
  <!-- SIDEBAR -->
  <aside class="w-72 p-4">
    <div class="glass rounded-2xl h-full p-4 flex flex-col neon">
      <div class="mb-6">
        <h2 class="text-2xl font-bold">PZEM SCADA</h2>
        <p class="small-muted mt-1">Agrupado por categor√≠a ‚Ä¢ Estilo B</p>
      </div>

      <nav class="mt-4 flex-1">
        <a href="#resumen" class="nav-link"><span>üè†</span><span>Resumen</span></a>
        <a href="#voltajes" class="nav-link"><span>‚ö°</span><span>Voltajes</span></a>
        <a href="#corrientes" class="nav-link"><span>üîå</span><span>Corrientes</span></a>
        <a href="#potencias" class="nav-link"><span>üîã</span><span>Potencias Activas</span></a>
        <a href="#reactivas" class="nav-link"><span>‚Ü©Ô∏è</span><span>Potencias Reactivas</span></a>
        <a href="#aparente" class="nav-link"><span>üî∂</span><span>Potencia Aparente</span></a>
        <a href="#fp" class="nav-link"><span>üîÅ</span><span>Factor Potencia</span></a>
        <a href="#energias" class="nav-link"><span>üìä</span><span>Energ√≠as</span></a>
      </nav>

      <div class="mt-auto text-xs small-muted">
        <div>√ölt. actualizaci√≥n: <span id="last-update">--:--:--</span></div>
        <div class="mt-2">Servidor: <strong id="server-status" class="text-green-400">Conectado</strong></div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 p-6">
    <!-- TOPBAR -->
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">Monitor PZEM ‚Äî Dashboard por Categor√≠a</h1>
        <p class="small-muted mt-1">Cada secci√≥n muestra sus datos y gr√°fica ‚Äî actualizaci√≥n cada 3s</p>
      </div>

      <div class="flex items-center gap-3">
        <button id="btn-refresh" class="topbar-btn glass">Refrescar</button>
        <button id="btn-export-all" class="topbar-btn glass">Exportar hist√≥rico</button>
      </div>
    </header>

    <!-- RESUMEN -->
    <section id="resumen" class="mb-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Voltaje Fase A</div>
          <div class="card-value" id="res-Va">-- V</div>
          <div class="small-muted">Estado: <span id="res-status-volt" class="status-pill">--</span></div>
        </div>

        <div class="glass rounded-xl p-4">
          <div class="small-muted">Corriente Fase A</div>
          <div class="card-value" id="res-Ia">-- A</div>
          <div class="small-muted">Estado: <span id="res-status-Ia" class="status-pill">--</span></div>
        </div>

        <div class="glass rounded-xl p-4">
          <div class="small-muted">Potencia Total (Pt)</div>
          <div class="card-value" id="res-Pt">-- W</div>
          <div class="small-muted">FP: <span id="res-FP">--</span></div>
        </div>
      </div>
    </section>

    <!-- VOLTAJES -->
    <section id="voltajes" class="mb-8">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-lg font-bold">Voltajes (Fase / L√≠nea)</h2>
          <p class="small-muted">Va, Vb, Vc y l√≠neas calculadas</p>
        </div>
        <div class="small-muted">√öltimos 30 puntos</div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Valores actuales</div>
          <div class="mt-2">
            <div class="data-row"><div class="key">Va</div><div class="val" id="Va">--</div></div>
            <div class="data-row"><div class="key">Vb</div><div class="val" id="Vb">--</div></div>
            <div class="data-row"><div class="key">Vc</div><div class="val" id="Vc">--</div></div>
            <div class="data-row"><div class="key">Vab</div><div class="val" id="Vab">--</div></div>
            <div class="data-row"><div class="key">Vbc</div><div class="val" id="Vbc">--</div></div>
            <div class="data-row"><div class="key">Vca</div><div class="val" id="Vca">--</div></div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 lg:col-span-2">
          <canvas id="chartVoltajes" height="160"></canvas>
        </div>
      </div>
    </section>

    <!-- CORRIENTES -->
    <section id="corrientes" class="mb-8">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-lg font-bold">Corrientes (Ia, Ib, Ic)</h2>
          <p class="small-muted">Tendencia de corrientes por fase</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Valores actuales</div>
          <div class="mt-2">
            <div class="data-row"><div class="key">Ia</div><div class="val" id="Ia">--</div></div>
            <div class="data-row"><div class="key">Ib</div><div class="val" id="Ib">--</div></div>
            <div class="data-row"><div class="key">Ic</div><div class="val" id="Ic">--</div></div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 lg:col-span-2">
          <canvas id="chartCorrientes" height="160"></canvas>
        </div>
      </div>
    </section>

    <!-- POTENCIAS ACTIVAS -->
    <section id="potencias" class="mb-8">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-lg font-bold">Potencias Activas (Pa, Pb, Pc, Pt)</h2>
          <p class="small-muted">Bar chart por fase + total</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Valores actuales</div>
          <div class="mt-2">
            <div class="data-row"><div class="key">Pa</div><div class="val" id="Pa">--</div></div>
            <div class="data-row"><div class="key">Pb</div><div class="val" id="Pb">--</div></div>
            <div class="data-row"><div class="key">Pc</div><div class="val" id="Pc">--</div></div>
            <div class="data-row"><div class="key">Pt</div><div class="val" id="Pt">--</div></div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 lg:col-span-2">
          <canvas id="chartPotActivas" height="160"></canvas>
        </div>
      </div>
    </section>

    <!-- POTENCIAS REACTIVAS -->
    <section id="reactivas" class="mb-8">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-lg font-bold">Potencias Reactivas (Qa, Qb, Qc, Qt)</h2>
          <p class="small-muted">Bar chart reactiva</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Valores actuales</div>
          <div class="mt-2">
            <div class="data-row"><div class="key">Qa</div><div class="val" id="Qa">--</div></div>
            <div class="data-row"><div class="key">Qb</div><div class="val" id="Qb">--</div></div>
            <div class="data-row"><div class="key">Qc</div><div class="val" id="Qc">--</div></div>
            <div class="data-row"><div class="key">Qt</div><div class="val" id="Qt">--</div></div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 lg:col-span-2">
          <canvas id="chartPotReactivas" height="160"></canvas>
        </div>
      </div>
    </section>

    <!-- POTENCIA APARENTE -->
    <section id="aparente" class="mb-8">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-lg font-bold">Potencia Aparente (Sa, Sb, Sc, St)</h2>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Valores actuales</div>
          <div class="mt-2">
            <div class="data-row"><div class="key">Sa</div><div class="val" id="Sa">--</div></div>
            <div class="data-row"><div class="key">Sb</div><div class="val" id="Sb">--</div></div>
            <div class="data-row"><div class="key">Sc</div><div class="val" id="Sc">--</div></div>
            <div class="data-row"><div class="key">St</div><div class="val" id="St">--</div></div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 lg:col-span-2">
          <canvas id="chartAparente" height="160"></canvas>
        </div>
      </div>
    </section>

    <!-- FACTOR DE POTENCIA -->
    <section id="fp" class="mb-8">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-lg font-bold">Factor de Potencia (FPa, FPb, FPc, FP_Total)</h2>
          <p class="small-muted">Tendencia FP</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Valores actuales</div>
          <div class="mt-2">
            <div class="data-row"><div class="key">FPa</div><div class="val" id="FPa">--</div></div>
            <div class="data-row"><div class="key">FPb</div><div class="val" id="FPb">--</div></div>
            <div class="data-row"><div class="key">FPc</div><div class="val" id="FPc">--</div></div>
            <div class="data-row"><div class="key">FP_Total</div><div class="val" id="FP_Total">--</div></div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 lg:col-span-2">
          <canvas id="chartFP" height="160"></canvas>
        </div>
      </div>
    </section>

    <!-- ENERGIAS -->
    <section id="energias" class="mb-12">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-lg font-bold">Energ√≠as (E_Act_Total, E_Rea_Total, E_App_Total)</h2>
          <p class="small-muted">Distribuci√≥n de energ√≠as</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Valores actuales</div>
          <div class="mt-2">
            <div class="data-row"><div class="key">E_Act_Total</div><div class="val" id="E_Pt">--</div></div>
            <div class="data-row"><div class="key">E_Rea_Total</div><div class="val" id="E_Qt">--</div></div>
            <div class="data-row"><div class="key">E_App_Total</div><div class="val" id="E_St">--</div></div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 lg:col-span-2">
          <canvas id="chartEnergias" height="160"></canvas>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
/* =======================
   CONFIG
   ======================= */
// Reemplaza con la URL de tu script Apps Script desplegado (Web App)
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbySLo9Y5s03tES8hedZ2nj7eZrqIINfQqqiVRXAjGUj94ACkTnXjCAVJdh1WIZsLMJZ/exec";

// Columnas pedidas (debe coincidir con tu backend map)
const COLUMNS = [
  "Va","Vb","Vc","Vab","Vbc","Vca",
  "Ia","Ib","Ic",
  "Fa","Fb","Fc",
  "Pa","Pb","Pc",
  "Qa","Qb","Qc",
  "Sa","Sb","Sc",
  "Pt","Qt","St",
  "FPa","FPb","FPc","FP_Total",
  "E_Pt","E_Qt","E_St"
];

let isFetching = false;
let maxPoints = 30;
let labels = [];
let dataStore = { Va:[], Vb:[], Vc:[], Ia:[], Ib:[], Ic:[], Pa:[], Pb:[], Pc:[], FPa:[], FPb:[], FPc:[] };

/* Charts holder */
let charts = {};

/* ------------------ Setup charts ------------------ */
function setupCharts(){
  const cVolt = document.getElementById("chartVoltajes").getContext("2d");
  charts.volt = new Chart(cVolt, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { label:"Va", data: dataStore.Va, borderWidth:2, tension:0.25 },
        { label:"Vb", data: dataStore.Vb, borderWidth:2, tension:0.25 },
        { label:"Vc", data: dataStore.Vc, borderWidth:2, tension:0.25 }
      ]
    },
    options:{ responsive:true }
  });

  const cCorr = document.getElementById("chartCorrientes").getContext("2d");
  charts.curr = new Chart(cCorr, {
    type:"line",
    data:{ labels:labels, datasets:[
      {label:"Ia", data:dataStore.Ia, borderWidth:2, tension:0.25},
      {label:"Ib", data:dataStore.Ib, borderWidth:2, tension:0.25},
      {label:"Ic", data:dataStore.Ic, borderWidth:2, tension:0.25}
    ]},
    options:{ responsive:true }
  });

  const cPot = document.getElementById("chartPotActivas").getContext("2d");
  charts.pot = new Chart(cPot, {
    type:"bar",
    data:{ labels:["Pa","Pb","Pc"], datasets:[{ label:"W", data:[0,0,0], backgroundColor:["#3b82f6","#7c3aed","#06b6d4"] }]},
    options:{ responsive:true }
  });

  const cQ = document.getElementById("chartPotReactivas").getContext("2d");
  charts.q = new Chart(cQ, {
    type:"bar",
    data:{ labels:["Qa","Qb","Qc"], datasets:[{ label:"VAR", data:[0,0,0], backgroundColor:["#f59e0b","#f97316","#fb923c"] }]},
    options:{ responsive:true }
  });

  const cS = document.getElementById("chartAparente").getContext("2d");
  charts.s = new Chart(cS, {
    type:"bar",
    data:{ labels:["Sa","Sb","Sc"], datasets:[{ label:"VA", data:[0,0,0], backgroundColor:["#ef4444","#f43f5e","#fb7185"] }]},
    options:{ responsive:true }
  });

  const cFP = document.getElementById("chartFP").getContext("2d");
  charts.fp = new Chart(cFP, {
    type:"line",
    data:{ labels:labels, datasets:[
      {label:"FPa", data:dataStore.FPa || [], borderWidth:2},
      {label:"FPb", data:dataStore.FPb || [], borderWidth:2},
      {label:"FPc", data:dataStore.FPc || [], borderWidth:2}
    ]},
    options:{ responsive:true }
  });

  const cE = document.getElementById("chartEnergias").getContext("2d");
  charts.energ = new Chart(cE, {
    type:"pie",
    data:{ labels:["E Activa","E Reactiva","E Aparente"], datasets:[{ data:[0,0,0], backgroundColor:["#3b82f6","#7c3aed","#06b6d4"] }]},
    options:{ responsive:true }
  });
}

/* ------------------ Helper format ------------------ */
const num = v => (v === null || v === undefined || v === "" ? 0 : Number(v));
const fmt = v => (v === null || v === undefined || v === "" ? "--" : (isNaN(Number(v)) ? v : Number(v).toFixed(2)));

/* ------------------ Fetch & update ------------------ */
async function fetchAndUpdate(){
  if (isFetching) return;
  isFetching = true;
  document.getElementById("last-update").textContent = new Date().toLocaleTimeString();

  try {
    const cols = COLUMNS.join(",");
    const resp = await fetch(`${GAS_WEB_APP_URL}?colsToQuery=${encodeURIComponent(cols)}`, {cache:"no-store"});
    const json = await resp.json();

    if (json.status !== "success") {
      throw new Error(json.error || "Backend error");
    }

    const d = json.data || {};

    // Update DOM grouped fields
    const mapping = {
      Va: fmt(d.Va), Vb: fmt(d.Vb), Vc: fmt(d.Vc),
      Vab: fmt(d.Vab), Vbc: fmt(d.Vbc), Vca: fmt(d.Vca),
      Ia: fmt(d.Ia), Ib: fmt(d.Ib), Ic: fmt(d.Ic),
      Fa: fmt(d.Fa), Fb: fmt(d.Fb), Fc: fmt(d.Fc),
      Pa: fmt(d.Pa), Pb: fmt(d.Pb), Pc: fmt(d.Pc),
      Qa: fmt(d.Qa), Qb: fmt(d.Qb), Qc: fmt(d.Qc),
      Sa: fmt(d.Sa), Sb: fmt(d.Sb), Sc: fmt(d.Sc),
      Pt: fmt(d.Pt), Qt: fmt(d.Qt), St: fmt(d.St),
      FPa: fmt(d.FPa), FPb: fmt(d.FPb), FPc: fmt(d.FPc), FP_Total: fmt(d.FP_Total),
      E_Pt: fmt(d.E_Pt), E_Qt: fmt(d.E_Qt), E_St: fmt(d.E_St)
    };

    Object.keys(mapping).forEach(k => {
      const el = document.getElementById(k);
      if (el) el.textContent = mapping[k];
    });

    // resumen top cards
    document.getElementById("res-Va").textContent = mapping.Va === "--" ? "-- V" : `${mapping.Va} V`;
    document.getElementById("res-Ia").textContent = mapping.Ia === "--" ? "-- A" : `${mapping.Ia} A`;
    document.getElementById("res-Pt").textContent = mapping.Pt === "--" ? "-- W" : `${mapping.Pt} W`;
    document.getElementById("res-FP").textContent = (d.FP_Total || d.FPa || d.FP) ? fmt(d.FP_Total || d.FPa || d.FP) : "--";

    // server status
    document.getElementById("server-status").textContent = "Conectado";
    document.getElementById("server-status").classList.remove("text-red-400");
    document.getElementById("server-status").classList.add("text-green-400");

    // push point to charts
    const label = new Date().toLocaleTimeString();
    pushPoint(label, num(d.Va), num(d.Vb), num(d.Vc), num(d.Ia), num(d.Ib), num(d.Ic), num(d.Pa), num(d.Pb), num(d.Pc), num(d.FPa), num(d.FPb), num(d.FPc), num(d.E_Pt), num(d.E_Qt), num(d.E_St));

  } catch (err) {
    console.error("Fetch error:", err);
    document.getElementById("server-status").textContent = "Error";
    document.getElementById("server-status").classList.remove("text-green-400");
    document.getElementById("server-status").classList.add("text-red-400");
  } finally {
    isFetching = false;
  }
}

/* ------------------ push point ------------------ */
function pushPoint(label, Va, Vb, Vc, Ia, Ib, Ic, Pa, Pb, Pc, FPa, FPb, FPc, Ept, Eq, Es){
  labels.push(label);
  dataStore.Va.push(Va); dataStore.Vb.push(Vb); dataStore.Vc.push(Vc);
  dataStore.Ia.push(Ia); dataStore.Ib.push(Ib); dataStore.Ic.push(Ic);
  dataStore.Pa.push(Pa); dataStore.Pb.push(Pb); dataStore.Pc.push(Pc);
  dataStore.FPa.push(FPa); dataStore.FPb.push(FPb); dataStore.FPc.push(FPc);

  if (labels.length > maxPoints){
    labels.shift();
    Object.keys(dataStore).forEach(k => dataStore[k].shift());
  }

  // update charts
  charts.volt.data.labels = labels;
  charts.volt.data.datasets[0].data = dataStore.Va;
  charts.volt.data.datasets[1].data = dataStore.Vb;
  charts.volt.data.datasets[2].data = dataStore.Vc;
  charts.volt.update();

  charts.curr.data.labels = labels;
  charts.curr.data.datasets[0].data = dataStore.Ia;
  charts.curr.data.datasets[1].data = dataStore.Ib;
  charts.curr.data.datasets[2].data = dataStore.Ic;
  charts.curr.update();

  charts.pot.data.datasets[0].data = [ Pa || 0, Pb || 0, Pc || 0 ];
  charts.pot.update();

  charts.q.data.datasets[0].data = [ num(document.getElementById("Qa").textContent), num(document.getElementById("Qb").textContent), num(document.getElementById("Qc").textContent) ];
  charts.q.update();

  charts.s.data.datasets[0].data = [ num(document.getElementById("Sa").textContent), num(document.getElementById("Sb").textContent), num(document.getElementById("Sc").textContent) ];
  charts.s.update();

  charts.fp.data.labels = labels;
  charts.fp.data.datasets[0].data = dataStore.FPa;
  charts.fp.data.datasets[1].data = dataStore.FPb;
  charts.fp.data.datasets[2].data = dataStore.FPc;
  charts.fp.update();

  // energ√≠as pie (latest values Ept,Eq,Es)
  charts.energ.data.datasets[0].data = [ Ept || 0, Eq || 0, Es || 0 ];
  charts.energ.update();

  // append to historical table (Resumen simple) - reuse historic in energias table
  addHistoricRow(label, Va, Vb, Vc, Ia, Ib, Ic, Pa);
}

/* ------------------ historic local table ------------------ */
function addHistoricRow(time, Va, Vb, Vc, Ia, Ib, Ic, Pt){
  const tbody = document.getElementById("historic-body");
  if(!tbody){
    // create a minimal historic table in Resumen if none exists
    return;
  }
}

/* Export all visible data (current snapshot) */
function exportCSVAll(){
  // snapshot from DOM keys
  const keys = ["Va","Vb","Vc","Vab","Vbc","Vca","Ia","Ib","Ic","Pa","Pb","Pc","Qa","Qb","Qc","Sa","Sb","Sc","Pt","Qt","St","FPa","FPb","FPc","FP_Total","E_Pt","E_Qt","E_St"];
  const row = keys.map(k => {
    const el = document.getElementById(k);
    return el ? (el.textContent || "") : "";
  });
  const csv = [keys.join(","), row.join(",")].join("\r\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `pzem_snapshot_${new Date().toISOString().slice(0,19)}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ------------------ init ------------------ */
document.addEventListener("DOMContentLoaded", () => {
  setupCharts();
  document.getElementById("btn-refresh").addEventListener("click", fetchAndUpdate);
  document.getElementById("btn-export-all").addEventListener("click", exportCSVAll);
  // Start auto refresh
  fetchAndUpdate();
  setInterval(fetchAndUpdate, 3000);
});
</script>

</body>
</html>
