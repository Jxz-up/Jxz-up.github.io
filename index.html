<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SCADA PZEM — Tiempo real + Histórico</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{--bg:#0b1221;--muted:#94a3b8;}
  html,body{height:100%;background:radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,0.05), transparent), var(--bg); color:#e6eef8; margin:0; font-family:Inter, system-ui;}
  .glass{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px); }
  .small-muted{ color: var(--muted); font-size:0.88rem; }
  .status-pill{ padding:6px 10px; border-radius:999px; font-size:0.82rem; background: rgba(255,255,255,0.02); }
  .data-row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,0.02); }
  .key{ color:var(--muted); font-size:0.9rem; }
  .val{ font-weight:600; }
  aside { position: fixed; top: 0; left: 0; height: 100vh; width: 18rem; overflow-y: auto; z-index: 50; padding: 1rem; }
  main { margin-left: 18rem; padding: 1.5rem; }
  .chart-card { padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015)); border:1px solid rgba(255,255,255,0.03); height: 280px; }
  input[type="datetime-local"] { color-scheme: dark; }
</style>
</head>

<body>
<div class="min-h-screen flex">
  <aside class="w-72 p-4">
    <div class="glass rounded-2xl h-full p-4 flex flex-col">
      <div class="mb-6">
        <h2 class="text-2xl font-bold">PZEM SCADA</h2>
        <p class="small-muted mt-1">Tiempo real + histórico por rango</p>
      </div>

      <div class="mt-auto text-xs small-muted">
        <div>Últ. actualización: <span id="last-update">--:--:--</span></div>
        <div class="mt-2">Servidor: <strong id="server-status" class="text-green-400">Conectado</strong></div>
        <div class="mt-2">Modo: <strong id="mode-pill">Tiempo real</strong></div>
        <div class="mt-2 text-red-300" id="history-msg"></div>
      </div>
    </div>
  </aside>

  <main class="flex-1">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">SCADA PZEM — Tiempo real + Histórico</h1>
        <p class="small-muted mt-1">Actualización automática cada 3s (en tiempo real)</p>
      </div>
      <button id="btn-refresh" class="glass status-pill">Refrescar</button>
    </header>

    <section class="mb-6 glass rounded-xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-lg font-bold">Histórico por rango</h2>
          <p class="small-muted">Selecciona Desde/Hasta y carga los datos para graficar el intervalo.</p>
        </div>
        <div class="small-muted">Recomendado: 10–60 minutos</div>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-4 gap-3">
        <div>
          <div class="small-muted mb-1">Desde</div>
          <input id="fromDT" type="datetime-local" class="glass w-full p-2 rounded-xl" />
        </div>
        <div>
          <div class="small-muted mb-1">Hasta</div>
          <input id="toDT" type="datetime-local" class="glass w-full p-2 rounded-xl" />
        </div>
        <div>
          <div class="small-muted mb-1">Máx. puntos</div>
          <input id="maxPoints" type="number" min="50" max="2000" value="300" class="glass w-full p-2 rounded-xl" />
        </div>
        <div class="flex gap-2 items-end">
          <button id="btn-history" class="glass status-pill w-full">Ver histórico</button>
          <button id="btn-realtime" class="glass status-pill w-full">Tiempo real</button>
        </div>
      </div>
    </section>

    <section class="mb-8">
      <h2 class="text-lg font-bold mb-2">Voltajes (V_A, V_B, V_C)</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="glass rounded-xl p-4">
          <div class="small-muted">Valores actuales</div>
          <div class="mt-2">
            <div class="data-row"><div class="key">V_A</div><div class="val" id="Va">--</div></div>
            <div class="data-row"><div class="key">V_B</div><div class="val" id="Vb">--</div></div>
            <div class="data-row"><div class="key">V_C</div><div class="val" id="Vc">--</div></div>
          </div>
        </div>
        <div class="glass rounded-xl p-4 lg:col-span-2 chart-card">
          <canvas id="chartVoltajes"></canvas>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
/* ===================== CONFIG ===================== */
const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz-jPO_x4ET5kNeDTrQVnLBAYpiMMux7I5TGPCnEYHd-8stih6ci2OC4iESWrA_Uk5q/exec"; // <-- CAMBIA ESTO

const COLUMNS = ["Va","Vb","Vc"];
const fmt = v => (v === null || v === undefined || v === "" ? "--" : (isNaN(Number(v)) ? v : Number(v).toFixed(2)));

let labels = [];
let charts = {};
let currentMode = "realtime";
let rtTimer = null;

const commonOptions = {
  responsive: true,
  interaction: { mode: 'index', intersect: false },
  plugins: { legend: { labels: { color: '#cfe6ff' } } },
  scales: {
    x: { ticks: { color: '#9fb5ff' }, grid: { color: 'rgba(255,255,255,0.02)' } },
    y: { ticks: { color: '#9fb5ff' }, grid: { color: 'rgba(255,255,255,0.03)' } }
  },
  maintainAspectRatio: false
};

function setMode(text){ document.getElementById('mode-pill').textContent = text; }
function setHistoryMsg(t){ document.getElementById('history-msg').textContent = t || ""; }

function setupChart(){
  if (charts.volt) charts.volt.destroy();
  charts.volt = new Chart(document.getElementById('chartVoltajes').getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[
      { label:'V_A', data:[], borderColor:'#60a5fa' },
      { label:'V_B', data:[], borderColor:'#f472b6' },
      { label:'V_C', data:[], borderColor:'#f59e0b' }
    ]},
    options: commonOptions
  });
}

/* ======== Helper: datetime-local value ======== */
function toDTLocalValue(d){
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function initDefaultRange(){
  const now = new Date();
  const from = new Date(now.getTime() - 30*60*1000); // últimos 30 min
  document.getElementById("toDT").value = toDTLocalValue(now);
  document.getElementById("fromDT").value = toDTLocalValue(from);
}

/* ===================== REALTIME ===================== */
async function fetchRealtime(){
  try{
    const url = `${GAS_WEB_APP_URL}?colsToQuery=${encodeURIComponent(COLUMNS.join(','))}`;
    const res = await fetch(url, { cache:"no-store" });
    const json = await res.json();
    if (json.status !== "success") throw new Error(json.error || "Error realtime");

    const d = json.data || {};
    const ts = d._ts ? new Date(d._ts) : new Date();
    const label = ts.toLocaleTimeString();

    document.getElementById('last-update').textContent = label;
    document.getElementById('server-status').textContent = "Conectado";
    setHistoryMsg("");

    document.getElementById("Va").textContent = fmt(d.Va);
    document.getElementById("Vb").textContent = fmt(d.Vb);
    document.getElementById("Vc").textContent = fmt(d.Vc);

    labels.push(label);
    if (labels.length > 30) labels.shift();

    charts.volt.data.labels = labels;
    charts.volt.data.datasets[0].data.push(Number(d.Va) || 0);
    charts.volt.data.datasets[1].data.push(Number(d.Vb) || 0);
    charts.volt.data.datasets[2].data.push(Number(d.Vc) || 0);

    charts.volt.data.datasets.forEach(ds => { if (ds.data.length > 30) ds.data.shift(); });
    charts.volt.update();
  }catch(err){
    console.error(err);
    document.getElementById('server-status').textContent = "Error";
  }
}

/* ===================== HISTORY ===================== */
async function fetchHistory(){
  const from = document.getElementById("fromDT").value;
  const to = document.getElementById("toDT").value;
  const maxPoints = document.getElementById("maxPoints").value || 300;

  if (!from || !to){
    setHistoryMsg("⚠️ Selecciona Desde/Hasta.");
    return;
  }

  const url = `${GAS_WEB_APP_URL}?mode=history&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&maxPoints=${encodeURIComponent(maxPoints)}&colsToQuery=${encodeURIComponent(COLUMNS.join(','))}`;

  document.getElementById('server-status').textContent = "Cargando histórico...";
  setHistoryMsg("");

  const res = await fetch(url, { cache:"no-store" });
  const json = await res.json();

  if (json.status !== "success"){
    console.error(json);
    setHistoryMsg("❌ Backend histórico: " + (json.error || "desconocido"));
    document.getElementById('server-status').textContent = "Error histórico";
    return;
  }

  if (!json.count){
    // ESTE ES TU CASO ACTUAL (rango sin datos)
    setHistoryMsg("⚠️ No hay datos en ese rango. Usa un rango que incluya los últimos minutos donde hay lecturas.");
    document.getElementById('server-status').textContent = "Histórico (0 pts)";
    return;
  }

  // ✅ CLAVE: NO reasignar labels, solo vaciar y rellenar (mantener referencia)
  labels.length = 0;
  json.labels.forEach(ts => labels.push(new Date(ts).toLocaleTimeString()));

  const toNumArray = (k) => (json.series?.[k] || []).map(v => Number(v) || 0);

  charts.volt.data.labels = labels;
  charts.volt.data.datasets[0].data = toNumArray("Va");
  charts.volt.data.datasets[1].data = toNumArray("Vb");
  charts.volt.data.datasets[2].data = toNumArray("Vc");
  charts.volt.update();

  // último valor del rango para panel
  const aVa = json.series?.Va || [];
  const aVb = json.series?.Vb || [];
  const aVc = json.series?.Vc || [];
  document.getElementById("Va").textContent = fmt(aVa[aVa.length-1]);
  document.getElementById("Vb").textContent = fmt(aVb[aVb.length-1]);
  document.getElementById("Vc").textContent = fmt(aVc[aVc.length-1]);

  document.getElementById('server-status').textContent = `Histórico (${json.count} pts)`;
  document.getElementById('last-update').textContent = labels[labels.length-1] || "--:--:--";
}

/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded", () => {
  setupChart();
  initDefaultRange();

  document.getElementById("btn-refresh").addEventListener("click", () => {
    if (currentMode === "realtime") fetchRealtime();
    else fetchHistory();
  });

  document.getElementById("btn-history").addEventListener("click", async () => {
    if (rtTimer) clearInterval(rtTimer);
    currentMode = "history";
    setMode("Histórico");
    await fetchHistory();
  });

  document.getElementById("btn-realtime").addEventListener("click", () => {
    if (rtTimer) clearInterval(rtTimer);
    currentMode = "realtime";
    setMode("Tiempo real");
    fetchRealtime();
    rtTimer = setInterval(fetchRealtime, 3000);
  });

  // start realtime
  fetchRealtime();
  rtTimer = setInterval(fetchRealtime, 3000);
});
</script>

</body>
</html>
