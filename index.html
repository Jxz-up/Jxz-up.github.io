<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Visualizador PZEM - Hist√≥rico y Tiempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Monitor de Energ√≠a (PZEM)</h1>

            <!-- Selecci√≥n par√°metros -->
            <!-- ... (mismos fieldsets de par√°metros que ya tienes, omitidos para ahorrar espacio aqu√≠) ... -->

            <div id="status-message" class="text-center p-4 my-4 text-gray-600 rounded-lg bg-gray-50 hidden"></div>

            <div id="data-container" class="space-y-4">
                <!-- ... (las fieldset de los datos, igual que tienes en tu base) ... -->
            </div>

            <fieldset id="fs-chart-container" class="hidden border border-gray-300 p-4 rounded-lg mt-6">
                <legend class="text-xl font-semibold text-gray-700 px-2">Gr√°fico en Tiempo Real</legend>
                <div class="p-2">
                    <canvas id="realTimeChart" style="max-height: 400px;"></canvas>
                </div>
            </fieldset>

            <hr class="my-8 border-gray-300">

            <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4">Consulta de Datos Hist√≥ricos üìä</h2>

            <fieldset class="mb-6 border border-indigo-300 p-4 rounded-lg bg-indigo-50">
                <legend class="text-lg font-semibold text-indigo-700 px-2">Selecci√≥n de Rango de Fechas</legend>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700">Fecha de Inicio (DD/MM/AAAA):</label>
                        <input type="text" id="startDate" placeholder="Ej: 25/11/2025" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700">Fecha Final (DD/MM/AAAA):</label>
                        <input type="text" id="endDate" placeholder="Ej: 26/11/2025" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <button id="fetchHistoricalBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150">Consultar Hist√≥rico</button>
                </div>
            </fieldset>

            <fieldset id="fs-historical-chart-container" class="hidden border border-gray-300 p-4 rounded-lg mt-4">
                <legend class="text-xl font-semibold text-gray-700 px-2">Gr√°fico Hist√≥rico</legend>
                <div id="historical-status" class="text-center p-2 my-2 text-gray-600"></div>
                <div class="p-2">
                    <canvas id="historicalChart" style="max-height: 450px;"></canvas>
                </div>
            </fieldset>

        </div>
    </div>

    <script>
        // ---------- CONFIG ----------
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxShRJ24Pk3Tftpcokkt3xNPehIL1WRfKb2b7GFsPemawrtTKuuN5v8zClXABGHfVdH/exec';
        const MAX_DATA_POINTS = 30;

        let realTimeChart = null;
        let historicalChart = null;
        let chartDataHistory = {};
        let isFetching = false;
        const colorPalette = ['#3b82f6','#ef4444','#10b981','#f97316','#a855f7','#64748b','#06b6d4','#f472b6'];

        function getFormattedDate(date) {
            const d = String(date.getDate()).padStart(2,'0');
            const m = String(date.getMonth()+1).padStart(2,'0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }

        function initializeChart(canvasId, chartType) {
            if (chartType === 'realTime' && realTimeChart) { realTimeChart.destroy(); }
            if (chartType === 'historical' && historicalChart) { historicalChart.destroy(); }

            const ctx = document.getElementById(canvasId).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: chartType === 'realTime' ? false : true,
                    plugins: { legend: { display: true }, title: { display: true, text: chartType === 'realTime' ? 'Comportamiento en Tiempo Real' : 'Datos Hist√≥ricos' }},
                    scales: { y: { beginAtZero: false }, x: { display: true, title: { display: chartType === 'historical', text: chartType === 'historical' ? 'Fecha y Hora' : '' } } }
                }
            });

            if (chartType === 'realTime') realTimeChart = chart; else historicalChart = chart;
        }

        function updateRealTimeChart(data) {
            if (!realTimeChart) return;

            let requestedCols = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
                requestedCols.push(...chk.dataset.cols.split(','));
            });
            const activeCols = [...new Set(requestedCols)].filter(k => k !== 'Timestamp');

            if (activeCols.length === 0) {
                document.getElementById('fs-chart-container').classList.add('hidden');
                return;
            }
            document.getElementById('fs-chart-container').classList.remove('hidden');

            const newTimestamp = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute:'2-digit', second:'2-digit', hour12:false });

            let newDatasets = [];

            activeCols.forEach((col,index) => {
                if (!chartDataHistory[col]) {
                    chartDataHistory[col] = {
                        label: col,
                        data: [],
                        borderColor: colorPalette[index % colorPalette.length],
                        backgroundColor: 'transparent',
                        tension: 0.2,
                        pointRadius: 3
                    };
                }

                const newValue = (data[col] !== undefined && data[col] !== null && data[col] !== "") ? parseFloat(data[col]) : null;
                chartDataHistory[col].data.push(newValue);
                if (chartDataHistory[col].data.length > MAX_DATA_POINTS) chartDataHistory[col].data.shift();
                newDatasets.push(chartDataHistory[col]);
            });

            // eliminar series no activas
            for (const k in chartDataHistory) {
                if (!activeCols.includes(k)) delete chartDataHistory[k];
            }

            if (!realTimeChart.data.labels) realTimeChart.data.labels = [];
            realTimeChart.data.labels.push(newTimestamp);
            if (realTimeChart.data.labels.length > MAX_DATA_POINTS) realTimeChart.data.labels.shift();

            realTimeChart.data.datasets = newDatasets;
            realTimeChart.update();
        }

        function renderHistoricalChart(historicalData) {
            const chartContainer = document.getElementById('fs-historical-chart-container');
            const statusDiv = document.getElementById('historical-status');

            let requestedCols = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
                requestedCols.push(...chk.dataset.cols.split(','));
            });
            const activeCols = [...new Set(requestedCols)].filter(k => k !== 'Timestamp');

            if (!Array.isArray(historicalData) || historicalData.length === 0) {
                statusDiv.textContent = 'No se encontraron datos en el rango seleccionado.';
                chartContainer.classList.remove('hidden');
                if (historicalChart) {
                    historicalChart.data.datasets = [];
                    historicalChart.data.labels = [];
                    historicalChart.update();
                }
                return;
            }

            statusDiv.textContent = `Mostrando ${historicalData.length} registros.`;
            chartContainer.classList.remove('hidden');

            const labels = historicalData.map(r => r.Timestamp);
            const datasets = activeCols.map((col, idx) => ({
                label: col,
                data: historicalData.map(r => { const v = r[col]; return (v === undefined || v === null || v === '') ? null : parseFloat(v); }),
                borderColor: colorPalette[idx % colorPalette.length],
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: 1
            }));

            if (historicalChart) historicalChart.destroy();
            initializeChart('historicalChart','historical');

            historicalChart.data.labels = labels;
            historicalChart.data.datasets = datasets;
            historicalChart.update();
        }

        async function fetchData() {
            if (isFetching) return;

            let requestedCols = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => requestedCols.push(...chk.dataset.cols.split(',')));
            if (requestedCols.length === 0) {
                document.getElementById('status-message').classList.add('hidden');
                document.getElementById('fs-chart-container').classList.add('hidden');
                return;
            }

            isFetching = true;
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = "Actualizando datos en tiempo real...";
            statusDiv.classList.remove('hidden','text-red-600','bg-red-100');
            statusDiv.classList.add('bg-gray-50','text-gray-600');

            try {
                const colsParam = [...new Set(requestedCols)].join(',');
                const url = `${GAS_WEB_APP_URL}?mode=realtime&colsToQuery=${encodeURIComponent(colsParam)}`;

                const res = await fetch(url, { redirect: 'follow' });
                const json = await res.json();

                if (json.status === 'success') {
                    updateUI(json.data);
                    updateRealTimeChart(json.data);
                    statusDiv.textContent = `Actualizado: Fila ${json.lastRow || ''}`;
                    statusDiv.classList.add('fade-in');
                } else {
                    throw new Error(json.error || 'Error RT desconocido');
                }
            } catch (err) {
                console.error("Error RT:", err);
                statusDiv.textContent = "Error RT: Fallo en conexi√≥n o datos.";
                statusDiv.classList.remove('text-gray-600','bg-gray-50');
                statusDiv.classList.add('text-red-600','bg-red-100','fade-in');
            } finally {
                isFetching = false;
            }
        }

        // -------------- MODIFICACI√ìN CRUCIAL AQU√ç ----------------
        function convertToBackendFormat(textDate, isEnd) {
            const parts = textDate.split('/');
            if (parts.length !== 3) return null;
            const [d,m,y] = parts;
            if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
            const datePart = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
            // Incluye los segundos para rango completo del d√≠a
            return isEnd ? `${datePart}T23:59:59` : `${datePart}T00:00:00`;
        }

        async function fetchHistoricalData() {
            const startDateText = document.getElementById('startDate').value.trim();
            const endDateText = document.getElementById('endDate').value.trim();
            const statusDiv = document.getElementById('historical-status');
            const chartContainer = document.getElementById('fs-historical-chart-container');
            const btn = document.getElementById('fetchHistoricalBtn');

            const startDate = convertToBackendFormat(startDateText, false);
            const endDate = convertToBackendFormat(endDateText, true);

            if (!startDate || !endDate) {
                statusDiv.textContent = 'Formato de fecha inv√°lido. Use DD/MM/AAAA.';
                chartContainer.classList.remove('hidden');
                return;
            }

            let requestedCols = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => requestedCols.push(...chk.dataset.cols.split(',')));
            if (requestedCols.length === 0) {
                statusDiv.textContent = 'Selecciona al menos un par√°metro para la consulta hist√≥rica.';
                chartContainer.classList.remove('hidden');
                return;
            }

            statusDiv.textContent = "Consultando datos hist√≥ricos...";
            chartContainer.classList.remove('hidden');
            btn.disabled = true;

            try {
                const colsParam = [...new Set(requestedCols)].join(',');
                const url = `${GAS_WEB_APP_URL}?mode=historical&start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}&colsToQuery=${encodeURIComponent(colsParam)}`;

                const res = await fetch(url, { redirect: 'follow' });
                const json = await res.json();

                if (json.status === 'success') {
                    if (Array.isArray(json.data)) {
                        renderHistoricalChart(json.data);
                    } else {
                        throw new Error("El servidor no devolvi√≥ un array de datos hist√≥ricos.");
                    }
                } else {
                    throw new Error(json.error || 'Error desconocido en la respuesta del servidor.');
                }
            } catch (err) {
                console.error("Error Hist√≥rico:", err);
                statusDiv.textContent = "Error: Fallo al consultar el historial. Revisa la consola.";
            } finally {
                btn.disabled = false;
            }
        }

        function updateUI(data) {
            for (const key in data) {
                const el = document.getElementById(`data-${key}`);
                if (!el) continue;
                const v = data[key];
                if (v === null || v === undefined || v === "") {
                    el.textContent = '‚Äî';
                } else if (!isNaN(parseFloat(v))) {
                    el.textContent = parseFloat(v).toFixed(3);
                } else {
                    el.textContent = v;
                }
            }
        }

        function toggleFieldsets() {
            document.querySelectorAll('#data-container fieldset').forEach(fs => fs.classList.add('hidden'));
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
                const fsId = `fs${chk.id.replace('chk','')}`;
                const fieldset = document.getElementById(fsId);
                if (fieldset) fieldset.classList.remove('hidden');
            });
            chartDataHistory = {};
            if (realTimeChart) {
                realTimeChart.data.labels = [];
                realTimeChart.data.datasets = [];
                realTimeChart.update();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeChart('realTimeChart','realTime');

            document.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.addEventListener('change', toggleFieldsets));
            document.getElementById('fetchHistoricalBtn').addEventListener('click', fetchHistoricalData);

            const now = new Date();
            document.getElementById('endDate').value = getFormattedDate(now);
            const start = new Date(now.getTime() - 24*60*60*1000);
            document.getElementById('startDate').value = getFormattedDate(start);

            fetchData();
            setInterval(fetchData, 5000);
        });
    </script>
</body>
</html>
