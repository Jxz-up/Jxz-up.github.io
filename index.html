<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard PZEM – Lectura en Vivo</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #eef2f3;
        margin: 0;
        padding: 20px;
        animation: fadeIn 1s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    h1 {
        text-align: center;
        font-size: 32px;
        animation: aparecer 1s ease;
    }

    @keyframes aparecer {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    #contenedor {
        max-width: 1000px;
        margin: auto;
        padding: 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        animation: subir 0.8s ease;
    }

    @keyframes subir {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        animation: fadeIn 1s ease;
    }

    table th, table td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        text-align: center;
    }

    table th {
        background: #0066ff;
        color: white;
    }

    .cargando {
        text-align: center;
        font-size: 22px;
        color: #444;
        margin-top: 20px;
        animation: parpadeo 1s infinite;
    }

    @keyframes parpadeo {
        0% { opacity: 0.3; }
        100% { opacity: 1; }
    }
</style>
</head>

<body>

<h1>Dashboard PZEM – Lecturas Guardadas</h1>

<div id="contenedor">
    <h2>Historial de Datos</h2>
    <div id="mensaje" class="cargando">Cargando datos...</div>

    <table id="tabla" style="display:none;">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Voltaje (V)</th>
                <th>Corriente (A)</th>
                <th>Potencia (W)</th>
                <th>Energía (Wh)</th>
                <th>Frecuencia (Hz)</th>
                <th>FP</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2 style="margin-top:40px;">Gráfica – Voltaje, Corriente y Potencia</h2>
    <canvas id="grafica"></canvas>
</div>

<script>
    const URL = "https://script.google.com/macros/s/AKfycbyk2UUS_Q7m8-lYFgstQECXmMRGnAr2hIcKVrM7emUiLEWEMXfH1svuDVUoGDC-t8RQ/exec";  // ← CAMBIA ESTO POR TU URL DEL APPS SCRIPT

    async function cargarDatos() {
        try {
            const res = await fetch(URL);
            const datos = await res.json();

            if (!Array.isArray(datos) || datos.length <= 1) {
                document.getElementById("mensaje").textContent = "NO SE ENCONTRARON DATOS";
                return;
            }

            document.getElementById("mensaje").style.display = "none";
            document.getElementById("tabla").style.display = "table";

            let tbody = document.querySelector("#tabla tbody");
            tbody.innerHTML = "";

            // Quitar encabezados
            const filas = datos.slice(1);

            let voltajes = [], corrientes = [], potencias = [], fechas = [];

            filas.forEach(row => {
                let fecha = new Date(row[0]).toLocaleString();
                fechas.push(fecha);
                voltajes.push(row[1]);
                corrientes.push(row[2]);
                potencias.push(row[3]);

                tbody.innerHTML += `
                    <tr>
                        <td>${fecha}</td>
                        <td>${row[1]}</td>
                        <td>${row[2]}</td>
                        <td>${row[3]}</td>
                        <td>${row[4]}</td>
                        <td>${row[5]}</td>
                        <td>${row[6]}</td>
                    </tr>
                `;
            });

            dibujarGrafica(fechas, voltajes, corrientes, potencias);

        } catch (error) {
            document.getElementById("mensaje").textContent = "ERROR al cargar datos";
            console.error(error);
        }
    }

    function dibujarGrafica(labels, volt, corr, pot) {
        new Chart(document.getElementById("grafica"), {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Voltaje (V)",
                        data: volt,
                        borderWidth: 2
                    },
                    {
                        label: "Corriente (A)",
                        data: corr,
                        borderWidth: 2
                    },
                    {
                        label: "Potencia (W)",
                        data: pot,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: "index" },
                animation: { duration: 1000 },
                scales: {
                    x: { title: { display: true, text: "Tiempo" } },
                    y: { title: { display: true, text: "Valores" } }
                }
            }
        });
    }

    cargarDatos();
</script>

</body>
</html>
